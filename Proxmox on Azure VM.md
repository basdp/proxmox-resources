# Proxmox on Azure
Use VM Standard D2as v6 (2 vcpus, 8 GiB memory) or E2ads_v6 (2 vcpus, 16 GiB memory)
Make sure it supports virtualization nesting

Change networking on the vnet to use 192.168.x.x subnet, 10.x.x.x is for the main network, we don't want azure to route that.

Use Debian Bookworm (12) OS

Follow this link for installation instructions for Proxmox: https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_12_Bookworm

Pay close attention to the `/etc/hosts` entry, `sources.list` (no-subscription) and kernel installation. Use the Azure **public IP address** for the entry in the hosts-file. Be sure to check 'use package maintainers version' when asked about the grub-config!

To disable azure automatically overriding `/etc/network/interfaces`, Run:
```bash
$ echo 'network: {config: disabled}' > /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
$ rm /etc/network/interfaces.d/50-cloud-init
```

Edit the `/etc/network/interfaces` file to be like this:
```
# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

auto lo
iface lo inet loopback

iface enP11029s1 inet manual

iface eth0 inet manual

auto vmbr0
iface vmbr0 inet dhcp
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0
```
Probably you need to adjust the interface name `enP11029s1` to the name on your system (check with `ip a` to see what's there).

Now run the PVE post install script:
```bash
$ bash -c "$(wget -qLO - https://github.com/community-scripts/ProxmoxVE/raw/main/misc/post-pve-install.sh)"
```
If you followed the whole installation steps above, you don't need to add or correct `apt` sources through the install script, so you can decline those.

**Reboot now**, and check if networking is working. Also check if your machine is reachable on the Proxmox admin url. Also check if DNS is working on the machine. If not, troubleshoot. check `/etc/resolv.conf` and the DNS settings in the Proxmox admin. I had to add `9.9.9.9` to the DNS server to get internet DNS working.

## Wireguard

Install Wireguard in Debian:
```bash
$ sudo apt update && sudo apt install wireguard
```

Generate WireGuard Keys for the Proxmox VM.
```bash
wg genkey | tee privatekey | wg pubkey > publickey
```
Keep these files somewhere safe, you only need the contents for later, the place you keep them is irrelevant.

On your WireGuard server, you will need the public key from the `publickey` file to create a peer entry.

Now edit the `/etc/wireguard/wg0.conf` file:

```ini
[Interface]
PrivateKey = <PRIVATEKEY FROM STEP ABOVE>
Address = 10.35.0.2/24  # Adjust to match your VPN ip and subnet created on the server side for this peer
DNS = 10.35.0.1  # (Optional) Your WireGuard VPN server's DNS

[Peer]
PublicKey = <YOUR_WIREGUARD_SERVER_PUBLIC_KEY>
Endpoint = <YOUR_WIREGUARD_SERVER_HOST>:<SERVER_PORT>
AllowedIPs = 10.0.0.0/8  # Adjust based on your main network. This is what will be routed over the VPN
PersistentKeepalive = 25
```

Enable the VPN:
```bash
$ sudo systemctl enable --now wg-quick@wg0
```

Reboot to make sure everything stays working!

## Done!

Maybe you want to set a password for user `root`, as the default user can't login to the Proxmox portal: `sudo passwd root`.

Also, if you want to move it into a cluster, make sure you change the ip address of the machine in `/etc/hosts` to the internal ip address (probably the one from your wireguard interface).